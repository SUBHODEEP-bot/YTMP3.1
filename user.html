<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#1db954">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TuneVerse">
  <link rel="manifest" href="/manifest.json">
  <title>TuneVerse ¬∑ Library</title>
  <meta name="description" content="TuneVerse Music Library - Your downloaded music collection">
  <link rel="stylesheet" href="/style.css?v=1.2.0">
  <link rel="stylesheet" href="/logo-styles.css?v=1.2.0">
  <link rel="icon" href="/logo.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/logo.svg">
</head>
<body class="user-page">
  <div class="container">
    <div id="pwaInsecureBanner" style="display:none;position:fixed;left:12px;right:12px;top:8px;z-index:12000;padding:10px;border-radius:8px;background:linear-gradient(90deg,#ffcc00,#ff8a00);color:#000;font-weight:700;text-align:center;box-shadow:0 6px 18px rgba(0,0,0,0.2)">Your connection is not secure ‚Äî PWA install may be disabled. Use <strong>localhost</strong> or an <strong>HTTPS</strong> URL (eg. via <em>ngrok</em>) to enable installation. <button id="pwaGuideBtn" style="margin-left:12px;padding:6px 10px;border-radius:6px;border:none;background:#000;color:#fff;cursor:pointer">How to fix</button></div>
    <!-- Header -->
    <header class="card header">
      <div class="header-with-logo">
        <!-- logo removed as requested -->
        <div class="header-text"><h1> TuneVerse</h1><p class="subtitle">Your Music Library</p></div>
      </div>
      <button id="installBtn" class="install-btn" style="display: none;">
        üì≤ Install App
      </button>
    </header>

    <!-- Folders View (Default) -->
    <section class="card" id="foldersSection">
      <div class="section-header">
        <h2>My Playlists & Albums</h2>
        <div class="header-buttons">
          <button id="openPersistentPlayerBtn" class="refresh-btn" title="Open a persistent player window that keeps playing when you leave this tab">üéß Player</button>
          <button id="refreshFoldersBtn" class="refresh-btn">Refresh</button>
          <button id="installBtn2" class="install-btn" style="display: none;">
            üì≤ Install App
          </button>
        </div>
      </div>
      <div id="foldersContainer" class="folders-grid">
        <div id="foldersLoading" class="loading-spinner">Loading your playlists...</div>
      </div>
    </section>

    <!-- Songs View (Hidden by default, shown when folder is clicked) -->
    <section class="card" id="songsSection" style="display:none">
      <div class="section-header">
        <button id="backToFoldersBtn" class="back-btn">‚Üê Back</button>
        <h2 id="currentFolderTitle">All Songs</h2>
        <button id="playCurrentFolderBtn" class="play-btn">‚ñ∂Ô∏è Play All</button>
      </div>
      <div id="songsContainer" class="songs-grid">
        <div id="songsLoading" class="loading-spinner">Loading songs...</div>
      </div>
    </section>

    <!-- Player -->
    <div id="playerModal" class="player-modal" style="display:none">
      <div class="player-content">
        <div class="player-header">
          <h3 id="playerTitle">Now Playing</h3>
          <button id="closePlayer" class="close-player">√ó</button>
        </div>
        <audio id="audioPlayer" controls preload="metadata"></audio>
        <div class="player-controls">
          <button id="rewindBtn" class="control-btn">‚è™ 10s</button>
          <button id="skipBtn" class="control-btn">‚è© 10s</button>
        </div>
      </div>
    </div>

    <footer class="footer card"><p>Made with ‚ù§Ô∏è for music lovers ‚Ä¢ TuneVerse</p></footer>
  </div>

  <script src="/script.js"></script>

  <script>
    // PWA Installation Handler
    let deferredPrompt = null;
    let isInstallable = false;

    console.log('üîß PWA Installation script loaded on user dashboard');

    // Listen for the beforeinstallprompt event
    window.addEventListener('beforeinstallprompt', (e) => {
        console.log('‚úÖ beforeinstallprompt event fired!');
        e.preventDefault();
        deferredPrompt = e;
        isInstallable = true;
        console.log('‚úÖ PWA is installable - deferredPrompt captured');
        showInstallPrompt();
    });

    // Listen for successful installation
    window.addEventListener('appinstalled', () => {
        console.log('‚úÖ PWA was installed successfully');
        hideInstallPrompt();
        deferredPrompt = null;
        isInstallable = false;
    });

    function showInstallPrompt() {
        console.log('üìç showInstallPrompt called');
        
        // Show existing buttons in the UI
        const installBtn = document.getElementById('installBtn');
        const installBtn2 = document.getElementById('installBtn2');
        
        console.log('üìç Found installBtn:', !!installBtn, 'installBtn2:', !!installBtn2);
        
        if (installBtn) {
            installBtn.style.display = 'block';
            console.log('‚úÖ installBtn shown');
            installBtn.onclick = handleInstallClick;
        }
        
        if (installBtn2) {
            installBtn2.style.display = 'block';
            console.log('‚úÖ installBtn2 shown');
            installBtn2.onclick = handleInstallClick;
        }
        
        // Also create floating button
        let floatingBtn = document.getElementById('pwaInstallBtn');
        // allow floating button to be created if global deferredPrompt exists
        if (!floatingBtn && (deferredPrompt || window.deferredPrompt)) {
            floatingBtn = document.createElement('button');
            floatingBtn.id = 'pwaInstallBtn';
            floatingBtn.innerHTML = 'üì• Install TuneVerse';
            floatingBtn.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                padding: 10px 16px;
                background: linear-gradient(135deg, #1db954 0%, #1ed760 100%);
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(29, 185, 84, 0.3);
                z-index: 10000;
                transition: all 0.3s ease;
            `;
            
            floatingBtn.addEventListener('mouseover', () => {
                floatingBtn.style.transform = 'translateY(-2px)';
                floatingBtn.style.boxShadow = '0 6px 16px rgba(29, 185, 84, 0.4)';
            });
            
            floatingBtn.addEventListener('mouseout', () => {
                floatingBtn.style.transform = 'translateY(0)';
                floatingBtn.style.boxShadow = '0 4px 12px rgba(29, 185, 84, 0.3)';
            });
            
            floatingBtn.onclick = handleInstallClick;
            document.body.appendChild(floatingBtn);
            console.log('‚úÖ Floating install button created');
        }
    }

    async function handleInstallClick(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        console.log('üñ±Ô∏è Install button clicked!');
        console.log('   deferredPrompt:', !!deferredPrompt);
        console.log('   isInstallable:', isInstallable);
        
        // Use local deferredPrompt, fallback to global window.deferredPrompt
        const promptEvent = deferredPrompt || window.deferredPrompt;
        if (!promptEvent) {
          console.error('‚ùå deferredPrompt is null/undefined!');
          alert('‚ùå Install prompt not available. Please try refreshing the page.');
          return;
        }
        
        try {
            console.log('üìå Calling promptEvent.prompt()...');
            promptEvent.prompt();
            console.log('‚úÖ Prompt shown to user');
            
            const { outcome } = await promptEvent.userChoice;
            console.log(`‚úÖ User response: ${outcome}`);
            
            if (outcome === 'accepted') {
                console.log('üéâ User accepted the install prompt!');
            } else {
                console.log('‚ÑπÔ∏è User dismissed the install prompt');
            }
            
            // clear both local and global references
            deferredPrompt = null;
            try { window.deferredPrompt = null; } catch(e){}
            isInstallable = false;
            hideInstallPrompt();
        } catch (error) {
            console.error('‚ùå Error in handleInstallClick:', error);
        }
    }

    function hideInstallPrompt() {
        const installBtn = document.getElementById('installBtn');
        const installBtn2 = document.getElementById('installBtn2');
        const floatingBtn = document.getElementById('pwaInstallBtn');
        
        if (installBtn) installBtn.style.display = 'none';
        if (installBtn2) installBtn2.style.display = 'none';
        if (floatingBtn) floatingBtn.style.display = 'none';
        
        console.log('‚úÖ Install buttons hidden');
    }

    // Check if already installed
    if (navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
        console.log('üì± App is already installed (standalone mode)');
        hideInstallPrompt();
    }

    // Register service worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
                .then((registration) => {
                    console.log('‚úÖ Service Worker registered successfully');
                    setInterval(() => {
                        registration.update();
                    }, 60000);
                })
                .catch((error) => {
                    console.log('‚ùå Service Worker registration failed:', error);
                });
        });
    } else {
        console.warn('‚ö†Ô∏è Service Worker not supported');
    }

    // If page is served insecurely (not https and not localhost), show guidance banner
    (function showInsecureBannerIfNeeded(){
      try {
        const isLocalhost = ['localhost','127.0.0.1','::1'].includes(window.location.hostname);
        const isSecure = window.location.protocol === 'https:' || isLocalhost;
        const banner = document.getElementById('pwaInsecureBanner');
        if (!isSecure && banner) {
          banner.style.display = 'block';
          const btn = document.getElementById('pwaGuideBtn');
          if (btn) btn.addEventListener('click', () => {
            const msg = `To enable PWA install, either:
  - Run the app on localhost (http://localhost:5000)
  - Or expose via HTTPS using ngrok: run \`ngrok http 5000\` and open the https URL
  After that, reload the page and click the Install button.`;
            alert(msg);
          });
        }
      } catch(e){ console.warn('Error checking secure context', e); }
    })();
  </script>
</body>
</html>
