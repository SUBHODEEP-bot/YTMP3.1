<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="#1db954">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TuneVerse">
    <link rel="manifest" href="/manifest.json">
    <title>TuneVerse ¬∑ Admin</title>
    <meta name="description" content="TuneVerse Admin Panel - Manage YouTube to MP3 conversions">
    
    <link rel="stylesheet" href="/style.css?v=1.2.0">
    <link rel="stylesheet" href="/logo-styles.css?v=1.2.0">
    <link rel="icon" href="/logo.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/logo.svg">
</head>
<body>
  <div class="container">
    <div id="pwaInsecureBanner" style="display:none;position:fixed;left:12px;right:12px;top:8px;z-index:12000;padding:10px;border-radius:8px;background:linear-gradient(90deg,#ffcc00,#ff8a00);color:#000;font-weight:700;text-align:center;box-shadow:0 6px 18px rgba(0,0,0,0.2)">Your connection is not secure ‚Äî PWA install may be disabled. Use <strong>localhost</strong> or an <strong>HTTPS</strong> URL (eg. via <em>ngrok</em>) to enable installation. <button id="pwaGuideBtn" style="margin-left:12px;padding:6px 10px;border-radius:6px;border:none;background:#000;color:#fff;cursor:pointer">How to fix</button></div>
    <header class="card header">
      <div class="header-with-logo">
        <img src="/logo.svg" class="header-logo" alt="TuneVerse">
        <div class="header-text"><h1>üéµ TuneVerse</h1><p class="subtitle">Admin Panel</p></div>
      </div>
      <button id="installButton" style="display: none; padding: 8px 16px; background: #1db954; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px;">
        üì± Install App
      </button>
    </header>

    <!-- Converter (visible to owner) -->
    <section class="card" id="converterCard">
      <div class="header"><h2>Add New Song</h2></div>
      <div class="form-container">
        <form id="convertForm">
          <div class="input-group">
            <input type="text" id="youtubeUrl" placeholder="Paste YouTube URL here..." required>
            <button type="button" id="infoBtn" class="new-folder-btn" onclick="fetchSongInfo()">Get Info</button>
            <button type="submit" id="convertBtn">
              <span class="btn-text">Convert</span>
              <span class="btn-loader" style="display:none"></span>
            </button>
          </div>

          <div class="folder-selector">
            <label for="folderSelect">Save to folder:</label>
            <select id="folderSelect"><option value="">Root (No folder)</option></select>
            <button type="button" id="newFolderBtn" class="new-folder-btn">+ New Folder</button>
            <button type="button" id="deleteFolderBtn" class="new-folder-btn" title="Delete selected folder">Delete Folder</button>
          </div>

          <div class="bitrate-selector">
            <label for="bitrateSelect">Audio Quality:</label>
            <select id="bitrateSelect"><option value="64">64 kbps</option><option value="128">128 kbps</option></select>
          </div>
        </form>

        <div id="song-info" class="song-info" style="display:none;">
          <img id="info-thumb" src="" alt="thumb" class="info-thumb">
          <div class="info-meta"><h3 id="info-title"></h3><div id="info-duration"></div><div id="info-uploader"></div></div>
        </div>

        <div id="statusMessage" class="status-message" style="display:none"></div>
        <div id="progressContainer" class="progress-container" style="display:none"><div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div><p id="progressText" class="progress-text">Processing...</p></div>
        <div id="downloadContainer" style="display:none" class="download-container"><h3 id="downloadTitle"></h3><button id="downloadBtn" class="btn">‚¨áÔ∏è Download</button></div>
      </div>
    </section>

    <!-- Library -->
    <section class="card" id="libraryCard">
      <div class="header"><h2>Your TuneVerse Library</h2><div class="header-actions"><button id="refreshBtn" class="refresh-btn">üîÑ Refresh</button> <button id="playAlbumBtn" class="refresh-btn">‚ñ∂Ô∏è Play Album</button> <button id="playAllBtn" class="refresh-btn">‚ñ∂Ô∏è Play All</button></div></div>
      <div id="folderTabs" class="folder-tabs"><button class="folder-tab active" data-folder="">All Files</button></div>
      <div id="libraryContainer" class="library-container">
        <div id="libraryLoading" class="library-loading">Loading files...</div>
        <div id="libraryEmpty" class="library-empty" style="display:none">No tracks yet.</div>
        <div id="libraryList" class="library-list"></div>
      </div>
    </section>

    <!-- Modals -->
    <div id="folderModal" class="modal" style="display:none"><div class="modal-content"><div class="modal-header"><h3>Create Folder</h3><button id="closeFolderModal" class="close-modal">√ó</button></div><div class="modal-body"><input id="newFolderName" placeholder="Folder name"><div class="modal-actions"><button id="createFolderBtn" class="btn primary">Create</button><button id="cancelFolderBtn" class="btn">Cancel</button></div></div></div></div>

    <!-- Player -->
    <div id="playerModal" class="player-modal" style="display:none"><div class="player-content"><div class="player-header"><h3 id="playerTitle">Now Playing</h3><button id="closePlayer" class="close-player">√ó</button></div><audio id="audioPlayer" controls preload="metadata"></audio><div class="player-controls"><button id="rewindBtn">‚è™</button><button id="skipBtn">‚è©</button></div></div></div>

    <script>
        // PWA Installation Handler
        let deferredPrompt = null;

        // Listen for the beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('‚úÖ PWA is installable - beforeinstallprompt event captured');
            showInstallPrompt();
        });

        // Listen for successful installation
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA was installed successfully');
            hideInstallPrompt();
            deferredPrompt = null;
        });

        function showInstallPrompt() {
            // Create floating button
            let floatingBtn = document.getElementById('pwaInstallBtn');
            if (!floatingBtn) {
                floatingBtn = document.createElement('button');
                floatingBtn.id = 'pwaInstallBtn';
                floatingBtn.innerHTML = 'Install TuneVerse';
                floatingBtn.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    padding: 10px 16px;
                    background: linear-gradient(135deg, #1db954 0%, #1ed760 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(29, 185, 84, 0.3);
                    z-index: 10000;
                    transition: all 0.3s ease;
                `;
                
                floatingBtn.addEventListener('mouseover', () => {
                    floatingBtn.style.transform = 'translateY(-2px)';
                    floatingBtn.style.boxShadow = '0 6px 16px rgba(29, 185, 84, 0.4)';
                });
                
                floatingBtn.addEventListener('mouseout', () => {
                    floatingBtn.style.transform = 'translateY(0)';
                    floatingBtn.style.boxShadow = '0 4px 12px rgba(29, 185, 84, 0.3)';
                });
                
                floatingBtn.addEventListener('click', handleInstallClick);
                document.body.appendChild(floatingBtn);
            }
        }

        async function handleInstallClick() {
          // prefer local deferredPrompt, fall back to global
          const promptEvent = deferredPrompt || window.deferredPrompt;
          if (!promptEvent) {
            console.warn('‚ö†Ô∏è Install prompt not available yet. Please refresh the page.');
            alert('Install prompt unavailable. Ensure you are on localhost or HTTPS.');
            return;
          }
            
          promptEvent.prompt();
          const { outcome } = await promptEvent.userChoice;
          console.log(`‚úÖ User response to install prompt: ${outcome}`);
          // clear references
          try { deferredPrompt = null; } catch(e){}
          try { window.deferredPrompt = null; } catch(e){}
          hideInstallPrompt();
        }

        function hideInstallPrompt() {
            const floatingBtn = document.getElementById('pwaInstallBtn');
            if (floatingBtn) {
                floatingBtn.style.display = 'none';
            }
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registered successfully:', registration);
                        setInterval(() => {
                            registration.update();
                        }, 60000);
                    })
                    .catch((error) => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }
        // Show insecure banner when not on https/localhost
        (function(){
          try {
            const isLocalhost = ['localhost','127.0.0.1','::1'].includes(window.location.hostname);
            const isSecure = window.location.protocol === 'https:' || isLocalhost;
            const banner = document.getElementById('pwaInsecureBanner');
            if (!isSecure && banner) {
              banner.style.display = 'block';
              const btn = document.getElementById('pwaGuideBtn');
              if (btn) btn.addEventListener('click', () => {
                const msg = `To enable PWA install, either:\n- Run the app on localhost (http://localhost:5000)\n- Or expose via HTTPS using ngrok: run \`ngrok http 5000\` and open the https URL\nAfter that, reload the page and click the Install button.`;
                alert(msg);
              });
            }
          } catch(e) { console.warn('Error checking secure context', e); }
        })();

        // Handle PWA installation
        window.addEventListener('appinstalled', () => {
          console.log('üì± PWA installed! Reloading to apply updates...');
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        });

        // Clear old caches on page load
        if ('caches' in window) {
          caches.keys().then(names => {
            names.forEach(name => {
              if (name && name.includes('tuneverse') && name !== 'tuneverse-v1.2.1') {
                console.log('[Cache] Clearing old cache:', name);
                caches.delete(name);
              }
            });
          });
        }
    </script>
    <footer class="footer card"><p>Made with ‚ù§Ô∏è for music lovers</p></footer>
  </div>

  <script src="/script.js"></script>
</body>
</html>